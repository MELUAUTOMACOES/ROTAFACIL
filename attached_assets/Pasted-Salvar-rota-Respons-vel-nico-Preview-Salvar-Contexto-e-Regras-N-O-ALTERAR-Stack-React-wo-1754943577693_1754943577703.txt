Salvar rota” + Responsável único + Preview/Salvar
Contexto e Regras (NÃO ALTERAR):

Stack: React (wouter) + Tailwind (front), Express + Drizzle (back).

Cores: #DAA520 e #B8860B.

A tela de Agendamentos já otimiza rotas e abre um drawer com { route, start, stops }.

Existe a tela de Roteirização (não sobrescrever, apenas adicionar o mesmo botão lá).

Objetivo:

Validar responsável único (mesmo técnico ou mesma equipe) antes de otimizar/salvar.

POST /api/routes/optimize deve funcionar como preview (NÃO salvar por padrão; só salvar se explicitamente solicitado).

Criar endpoint de salvar via PATCH /api/routes/:id/status (mudar de draft para optimized).

Adicionar botão “Salvar rota” nos drawers de Agendamentos e Roteirização.

Não alterar outras telas/rotas além do indicado.

Manter logs e toasts já existentes.

1) BACKEND — server/routes/routes.api.ts
1.1 Validação de responsável único no handler de POST /api/routes/optimize

Após obter selectedAppointments (e antes de calcular matriz OSRM), adicione:

ts
Copiar
Editar
// ✅ Garantir responsável único entre os agendamentos selecionados
const responsibles = selectedAppointments.map((a: any) => {
  if (a.technicianId && !a.teamId) return `technician:${a.technicianId}`;
  if (a.teamId && !a.technicianId) return `team:${a.teamId}`;
  return null;
}).filter(Boolean);

const uniqueResponsibles = Array.from(new Set(responsibles));
if (uniqueResponsibles.length !== 1) {
  return res.status(400).json({
    error: "Seleção inválida",
    details: "Todos os agendamentos devem pertencer ao mesmo responsável (mesmo técnico ou mesma equipe)."
  });
}

const [respType, respId] = uniqueResponsibles[0].split(':');
const derivedResponsibleType = respType as 'technician' | 'team';
const derivedResponsibleId = respId;
1.2 Optimize como PREVIEW por padrão

No Zod schema do optimize, permita preview?: boolean, aceite appointmentIds número/string e torne responsibleType/Id opcionais (serão derivados):

ts
Copiar
Editar
const optimizeRouteSchema = z.object({
  appointmentIds: z.array(z.union([z.string(), z.number()])),
  endAtStart: z.boolean(),
  responsibleType: z.enum(['technician','team']).optional(),
  responsibleId: z.union([z.string(), z.number()]).optional(),
  vehicleId: z.string().optional(),
  title: z.string().optional(),
  preview: z.boolean().optional()
});
Normalize os IDs:

ts
Copiar
Editar
const { appointmentIds, endAtStart, vehicleId, title, preview } = validation.data;
const appointmentIdsNorm = appointmentIds.map((id: any) => Number(id));
Ao filtrar selectedAppointments, use appointmentIdsNorm.

Resposta PREVIEW (se preview !== false): NÃO salvar no banco; retorne { route: {..., id: null, responsible: { type: derivedResponsibleType, id: derivedResponsibleId }}, start, stops }.

Salvar somente se preview === false (com routes e route_stops), usando derivedResponsibleType/Id.

Status inicial ao salvar: draft. (Se já estiver como optimized, troque para draft.)

1.3 Endpoint para SALVAR (mudar status)

Criar:

ts
Copiar
Editar
const updateStatusSchema = z.object({
  status: z.enum(["draft","optimized","running","done","canceled"])
});

app.patch('/api/routes/:id/status', authenticateToken, async (req: any, res: Response) => {
  try {
    const routeId = req.params.id;
    const parsed = updateStatusSchema.safeParse(req.body);
    if (!parsed.success) return res.status(400).json({ error: "Status inválido" });
    const { status } = parsed.data;

    const [updated] = await db
      .update(routes)
      .set({ status })
      .where(eq(routes.id, routeId))
      .returning();

    if (!updated) return res.status(404).json({ error: "Rota não encontrada" });
    res.json({ ok: true, route: updated });
  } catch (e: any) {
    console.error("Erro ao atualizar status:", e);
    res.status(500).json({ error: "Erro ao atualizar status", details: e.message });
  }
});
Observação: se seu código já estiver no modelo de preview (sem salvar) por alterações anteriores, apenas garanta que status inicial ao salvar seja draft e o PATCH acima exista.

2) FRONT — Agendamentos client/src/pages/Appointments.tsx
2.1 Validar responsável único antes de otimizar

Dentro de handleOptimizeRoute, após checar selectedAppointmentIds.length < 2, adicione:

ts
Copiar
Editar
// ✅ Responsável único (mesmo técnico OU mesma equipe)
const selected = filteredAppointments.filter(apt => selectedAppointmentIds.includes(apt.id));
const keys = selected.map(apt =>
  apt.technicianId ? `technician-${apt.technicianId}` :
  apt.teamId ? `team-${apt.teamId}` : null
).filter(Boolean);
const uniqueKeys = Array.from(new Set(keys));
if (uniqueKeys.length !== 1) {
  toast({
    title: "Seleção inválida",
    description: "Não é possível otimizar rota com técnicos/equipes diferentes. Selecione do mesmo responsável.",
    variant: "destructive",
  });
  return;
}
2.2 Chamar optimize em modo PREVIEW

Na requisição fetch("/api/routes/optimize"...), envie preview: true e não envie responsibleType/Id (o back deriva):

ts
Copiar
Editar
body: JSON.stringify({
  appointmentIds: selectedAppointmentIds, // números
  endAtStart,
  title: `Rota ${new Date().toLocaleDateString()}`,
  preview: true
}),
2.3 Botão “Salvar rota” no drawer

No bloco de botões do drawer quando optimizedRoute && !isOptimizing, adicione:

tsx
Copiar
Editar
{optimizedRoute?.route?.id && optimizedRoute?.route?.status !== 'optimized' && (
  <Button
    className="w-full bg-burnt-yellow hover:bg-burnt-yellow-dark text-white"
    onClick={async () => {
      try {
        const res = await fetch(`/api/routes/${optimizedRoute.route.id}/status`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ status: "optimized" })
        });
        if (!res.ok) throw new Error("Falha ao salvar rota");
        const data = await res.json();
        setOptimizedRoute(prev => prev ? ({ ...prev, route: { ...prev.route, status: "optimized" } }) : prev);
        toast({ title: "Rota salva", description: "A rota agora aparece no Histórico." });
      } catch (e: any) {
        toast({ title: "Erro ao salvar rota", description: e.message || "Erro desconhecido", variant: "destructive" });
      }
    }}
  >
    Salvar rota
  </Button>
)}
2.4 Resumo mostra status (opcional)

tsx
Copiar
Editar
<div className="flex justify-between">
  <span>Status:</span>
  <span className="font-medium">
    {optimizedRoute.route?.status === 'optimized' ? 'Otimizada' : 'Rascunho'}
  </span>
</div>
3) FRONT — Roteirização (mesmo botão e validação)
Localize o arquivo da tela de Roteirização (NÃO sobrescrever a página; apenas editar onde renderiza a rota otimizada).

Adicionar a mesma validação de responsável único antes de otimizar.

Adicionar o mesmo botão “Salvar rota” chamando PATCH /api/routes/:id/status para optimized.

Não alterar outros fluxos/estilos; usar as mesmas cores.

4) Testes esperados
Selecionar 2+ agendamentos do mesmo responsável → OK; de responsáveis diferentes → erro (toast).

Ao otimizar, drawer mostra rota; se for preview sem id, primeiro chame optimize com preview === false (salva como draft) ou ajuste para que o optimize já crie como draft e retorne id.

Botão Salvar rota muda o status para optimized via PATCH.

A rota aparece na página Histórico de Rotas com status atualizado.

Observação importante para o AI:

Se o optimize já está em modo preview no projeto, mantenha assim.

Se o optimize ainda salva diretamente, mude para o fluxo descrito: preview por padrão, e salvar apenas quando preview === false ou via PATCH de status após a criação.

Em todos os casos, o status final deve mudar para optimized quando o usuário clicar em Salvar rota no drawer.