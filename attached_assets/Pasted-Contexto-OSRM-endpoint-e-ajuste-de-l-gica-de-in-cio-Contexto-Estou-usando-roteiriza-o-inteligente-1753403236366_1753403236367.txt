Contexto OSRM, endpoint e ajuste de lógica de início
Contexto:
Estou usando roteirização inteligente via OSRM (Open Source Routing Machine), que calcula a melhor rota de acordo com uma lista de coordenadas (latitude, longitude).
No meu backend, tenho este endpoint (em server/routes.ts) que funciona como proxy para o OSRM:

js
Copiar
Editar
app.get("/api/route", async (req, res) => {
  try {
    const coords = req.query.coords as string;
    if (!coords) {
      return res.status(400).json({ error: "Missing 'coords' parameter" });
    }
    const OSRM_URL = getOsrmUrl()?.replace(/\/$/, '') || null;
    if (!OSRM_URL) {
      return res.status(500).json({ error: "Endereço OSRM não configurado. Crie/atualize o arquivo osrm_url.txt." });
    }
    const osrmUrl = `${OSRM_URL}/route/v1/driving/${coords}?overview=full&geometries=geojson`;
    const osrmRes = await fetch(osrmUrl, { headers: { "ngrok-skip-browser-warning": "true" } });
    if (!osrmRes.ok) {
      const text = await osrmRes.text();
      return res.status(500).json({ error: `OSRM error: ${text.substring(0, 300)}` });
    }
    const data = await osrmRes.json();
    return res.json(data);
  } catch (err) {
    return res.status(500).json({ error: "Erro no proxy OSRM" });
  }
});
O front-end envia uma string de coordenadas nesse formato:
"lon1,lat1;lon2,lat2;lon3,lat3"
O OSRM calcula a melhor rota, devolvendo tempo, distância e o caminho.

O que quero garantir:

O primeiro ponto do array de coordenadas SEMPRE deve ser o endereço de início correto, para refletir o local de saída do técnico/equipe (se houver), ou da empresa (caso contrário).

Regras para implementar:

No front-end:

Sempre comece o array de coordenadas pelo endereço de início correto:

Se o cadastro do técnico/equipe tiver endereço de início preenchido (endereco_inicio_*), use esse.

Senão, use o endereço da empresa (endereco_empresa_*).

Geocodifique esse endereço para latitude/longitude (Nominatim ou equivalente).

Só monte a string para o OSRM e envie para /api/route se todos os pontos tiverem coordenadas válidas.

Valide antes de enviar:

Se não conseguir converter o endereço de início em coordenada, mostre mensagem de erro e bloqueie o envio.

Se algum agendamento/parada não tiver coordenada, bloqueie também.

O botão de "Otimizar Rotas" só pode ser clicável quando tudo estiver válido.

No backend:

O endpoint pode manter a lógica atual, apenas repassando as coordenadas ao OSRM.

Adicione validação para garantir pelo menos dois pontos na query coords.

Não alterar nenhuma outra lógica do sistema.

Resumo:

Sempre respeite a regra:
Endereço de início = técnico/equipe (se tiver) > empresa (senão).

O array de coordenadas deve começar pelo ponto de início.

Só chamar o backend se todas as coordenadas estiverem corretas.

Se precisar, mostre exemplos no log de como deve ficar a string de coordenadas enviada ao backend em cada cenário (endereço opcional ou não).